rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superAdmin'];
    }
    function isMemberOf(churchId) {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)/memberships/$(churchId));
    }
    function userChurchId(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.churchId;
    }

    match /users/{uid} {
      allow read: if isSignedIn() && (request.auth.uid == uid || isAdmin());
      allow write: if isSignedIn() && request.auth.uid == uid;
    }

    match /churches/{churchId} {
      allow read: if true;
      allow write: if isAdmin() && userChurchId(request.auth.uid) == churchId;

      match /sermons/{sid} {
        allow read: if true;
        allow write: if isAdmin() && userChurchId(request.auth.uid) == churchId;
      }

      match /events/{eid} {
        allow read: if true;
        allow write: if isAdmin() && userChurchId(request.auth.uid) == churchId;
      }

      match /announcements/{aid} {
        allow read: if resource.data.status == 'published' || isAdmin();
        allow write: if isAdmin() && userChurchId(request.auth.uid) == churchId;
      }

      match /news/{nid} {
        allow read: if resource.data.status == 'published' || isAdmin();
        allow write: if isAdmin() && userChurchId(request.auth.uid) == churchId;
      }

      match /reports/{rid} {
        allow read: if isAdmin() && userChurchId(request.auth.uid) == churchId;
        allow write: if isAdmin() && userChurchId(request.auth.uid) == churchId;
      }
    }
  }
}