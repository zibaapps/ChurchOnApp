rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superAdmin'];
    }
    function isMemberOf(churchId) {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid)/memberships/$(churchId));
    }
    function userChurchId(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.churchId;
    }

    match /users/{uid} {
      allow read: if isSignedIn() && (request.auth.uid == uid || isAdmin());
      allow write: if isSignedIn() && request.auth.uid == uid;
    }

    match /churches/{churchId} {
      allow read: if true;
      allow write: if isAdmin() && isMemberOf(churchId);

      match /sermons/{sid} {
        allow read: if true;
        allow write: if isMemberOf(churchId) && isAdmin();
      }

      match /events/{eid} {
        allow read: if true;
        allow write: if isMemberOf(churchId) && isAdmin();
      }

      match /announcements/{aid} {
        allow read: if resource.data.status == 'published' || (isMemberOf(churchId) && isAdmin());
        allow write: if isMemberOf(churchId) && isAdmin();
      }

      match /news/{nid} {
        allow read: if resource.data.status == 'published' || (isMemberOf(churchId) && isAdmin());
        allow write: if isMemberOf(churchId) && isAdmin();
      }

      match /reports/{rid} {
        allow read, write: if isMemberOf(churchId) && isAdmin();
      }
    }

    // Domain mapping for web
    match /domains/{host} {
      allow read: if true; // public mapping host -> churchId
      allow write: if isAdmin();
    }

    // Interchurch Activities
    match /interchurch_activities/{activityId} {
      allow read: if true; // client filters by visibility and membership
      allow create: if isAdmin();
      allow update, delete: if isAdmin();

      // RSVP and attendance subcollections per church (optional future)
      match /{anySub=**} {
        allow read, write: if isSignedIn();
      }
    }

    // Year Program Entries (flat collection powering Programs screen)
    match /year_program_entries/{entryId} {
      allow read: if true; // client filters by status and participants
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }
  }
}