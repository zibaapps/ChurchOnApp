rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['admin', 'superAdmin'];
    }
    function isMemberOf(churchId) {
      return isSignedIn() && exists(/databases/$(database)/documents/users/$(request.auth.uid)/memberships/$(churchId));
    }
    function userChurchId(uid) {
      return get(/databases/$(database)/documents/users/$(uid)).data.churchId;
    }
    function churchActive(chId) {
      return get(/databases/$(database)/documents/churches/$(chId)).data.active == true;
    }

    match /users/{uid} {
      allow read: if isSignedIn() && (request.auth.uid == uid || isAdmin());
      allow write: if isSignedIn() && request.auth.uid == uid;
    }

    match /churches/{churchId} {
      allow read: if true;
      allow write: if isAdmin() && isMemberOf(churchId);

      match /sermons/{sid} {
        allow read: if true;
        allow write: if isMemberOf(churchId) && isAdmin() && churchActive(churchId);
      }

      match /events/{eid} {
        allow read: if true;
        allow write: if isMemberOf(churchId) && isAdmin() && churchActive(churchId);
      }

      match /announcements/{aid} {
        allow read: if resource.data.status == 'published' || (isMemberOf(churchId) && isAdmin());
        allow write: if isMemberOf(churchId) && isAdmin() && churchActive(churchId);
      }

      match /news/{nid} {
        allow read: if resource.data.status == 'published' || (isMemberOf(churchId) && isAdmin());
        allow write: if isMemberOf(churchId) && isAdmin() && churchActive(churchId);
      }

      match /reports/{rid} {
        allow read, write: if isMemberOf(churchId) && isAdmin() && churchActive(churchId);
      }

      match /payments/{pid} {
        allow read: if isMemberOf(churchId);
        allow write: if isMemberOf(churchId) && churchActive(churchId);
      }

      match /tithes/{tid} {
        allow read: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
        allow write: if isAdmin() && churchActive(churchId);
      }

      match /contribution_pools/{cid} {
        allow read: if isMemberOf(churchId);
        allow write: if isAdmin() && churchActive(churchId);
      }

      // Games Scores per church
      match /games_scores/{scoreId} {
        allow read: if true;
        allow create: if isSignedIn();
        allow update, delete: if false;
      }
    }

    // Domain mapping for web
    match /domains/{host} {
      allow read: if true; // public mapping host -> churchId
      allow write: if isAdmin();
    }

    // Global games leaderboard only stores opt-in submissions
    match /global_games_scores/{scoreId} {
      allow read: if true;
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    // Interchurch Activities
    match /interchurch_activities/{activityId} {
      allow read: if true; // client filters by visibility and membership
      allow create: if isAdmin();
      allow update, delete: if isAdmin();

      match /{anySub=**} {
        allow read, write: if isSignedIn();
      }
    }

    // Year Program Entries (flat collection powering Programs screen)
    match /year_program_entries/{entryId} {
      allow read: if true; // client filters by status and participants
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }
  }
}